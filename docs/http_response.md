# http_response

Source: `includes/http_response.hpp`

The `http_response` class models an outgoing HTTP response. It is a move-only object that helps construct status line, headers, body and trailers and provides `send()` and `end()` helpers that use server-supplied callbacks to transmit and close the connection.

## Design goals

- Provide a safe, ownership-aware response object for request handlers.
- Normalize header/trailer names for consistent storage and lookup.
- Keep I/O out of the object's core logic by delegating sending/closing to server callbacks.

## Key characteristics

- Move-only: disables copying; move construction is available.
- Header/trailer normalization: names are normalized to upper-case internally (via `to_upper_case`).
- Defaults: HTTP/1.1, status 200 "OK", empty body by default.
- Send & end: `send()` formats and transmits the response via `send_message`, `end()` validates then calls `close_connection`.
- Not thread-safe: intended for use by the owning thread.

## Constructors & destructor

### `http_response(...)` (private)

Signature

```cpp
http_response(const std::string &version, const std::multimap<std::string, std::string> &headers,
               std::function<void()> close_connection,
               std::function<void(const std::string &)> send_message)

```

Purpose

- Construct a response object with initial headers and callbacks for sending and closing. Constructor normalizes header names to upper-case.

Notes

- This constructor is private and intended to be used by `http_server` (friend).

### `~http_response()`

- Default destructor; releases resources and callbacks.

## Move semantics

- `http_response(http_response &&other)` â€” transfers ownership of fields and callbacks. The moved-from object has `status_code` set to 0 and callbacks reset to null to mark it invalid.
- Move assignment is deleted.

## Public API (function-level detail)

#### `std::string to_string() const`

- Signature: `std::string to_string() const`
- Purpose: Format the response into an HTTP wire-format string (status line, headers, CRLF, body, trailers). The implementation also injects a `Date` header generated by an internal `get_current_date()` helper following RFC 1123.
- Notes: This does not perform network I/O; useful for logging or inspection.

#### `void set_body(const std::string &body)`

- Replace the current response body.

#### `void set_status(int status_code, const std::string &status_message)`

- Set numeric status and textual reason phrase.

#### `void set_version(const std::string &version)`

- Set HTTP version string used in the status line.

#### `void add_header(const std::string &name, const std::string &value)`

- Add a header; name is normalized to upper-case before storage.

#### `void add_trailer(const std::string &name, const std::string &value)`

- Add a trailer header; name is normalized to upper-case before storage. Trailers are intended for chunked responses.

#### `std::string get_body() const`

- Return the current body string.

#### `std::string get_version() const`

- Return the HTTP version string.

#### `std::string get_status_message() const`

- Return the textual status message.

#### `int get_status_code() const`

- Return the numeric status code.

#### `std::vector<std::string> get_header(const std::string &name) const`

- Return all values for the given header name; lookup is normalized to upper-case.

#### `std::vector<std::string> get_trailer(const std::string &name) const`

- Return all values for the given trailer name; lookup is normalized to upper-case.

#### `void clear_header_values(const std::string &name)`

- Erase all headers with the given name from the internal storage.

#### `void send()`

- Format the response with `to_string()`, call `validate()` and then invoke the server-supplied `send_message(...)` callback. If validation fails or an exception occurs, `send()` throws a `std::runtime_error` with an explanatory message.

#### `void send_trailers()`

- Send any trailers that have been added to the response. Trailers are sent after the response body and headers.

#### `void end()`

- Validate the response and then invoke the `close_connection()` callback to close the underlying client connection. If validation fails, `end()` throws a `std::runtime_error`.

## Examples

### Simple 200 response

```cpp
hh_http::http_response res = /* provided by server */;

res.set_body("Hello, world!\n");
res.add_header("Content-Type", "text/plain; charset=utf-8");
res.add_header("Content-Length", std::to_string(res.get_body().size()));
res.send();
res.end();
```

### 404 Not Found

```cpp
hh_http::http_response res = /* provided by server */;

res.set_status(404, "Not Found");
res.set_body("Page not found\n");
res.add_header("Content-Type", "text/plain");
res.send();
res.end();
```

## Notes and best practices

- `to_string()` injects a `Date` header via `get_current_date()`; override or add other headers as needed.
- `end()` finalizes the response and closes the connection. Avoid calling `end()` if you intend to reuse the connection for persistent sessions unless the server's policy supports it.
- When setting the response body directly, ensure `Content-Length` is accurate unless using chunked transfer encoding.
- Trailers require chunked transfer encoding in HTTP/1.1; confirm server support before relying on them.
- The class is move-only and not thread-safe; move it into asynchronous senders or closures rather than copying.
